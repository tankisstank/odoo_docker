<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <record id="view_order_form_inherit_trade_in_combined_picking" model="ir.ui.view">
            <field name="name">sale.order.form.inherit.trade_in.combined</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
                <!-- Arrow Button Logic Removed -->
            <field name="arch" type="xml">
                <!-- Add Pawn Button to Header -->
                <xpath expr="//header" position="inside">
                    <!-- Ensure custom_state is loaded for attrs evaluation -->
                    <field name="custom_state" invisible="1"/>
                    <button name="%(qlv.action_pawn_order)d" string="Gửi sổ / Cầm cố" type="action" class="btn-secondary" 
                        icon="fa-book"
                        attrs="{'invisible': [('state', '!=', 'draft')]}"/>
                    <button name="action_super_cancel" string="Hủy đơn hàng" type="object" class="btn-danger"
                        confirm="CẢNH BÁO: Bạn đang thực hiện HỦY ĐƠN HÀNG. Hệ thống sẽ tự động hoàn tác các phiếu kho và hóa đơn liên quan. Bạn có chắc chắn muốn tiếp tục?"
                        attrs="{'invisible': [('state', 'not in', ['sale', 'done'])]}"/>
                </xpath>

                <xpath expr="//field[@name='partner_id']" position="attributes">
                     <attribute name="attrs">{'readonly': ['|', '|', ('state', 'in', ['done', 'cancel']), ('custom_state', '=', 'invoiced'), ('custom_state', '=', 'done_delivery')]}</attribute>
                </xpath>
                <xpath expr="//field[@name='order_line']" position="attributes">
                     <attribute name="attrs">{'readonly': ['|', '|', ('state', 'in', ['done', 'cancel']), ('custom_state', '=', 'invoiced'), ('custom_state', '=', 'done_delivery')]}</attribute>
                </xpath>

                <xpath expr="//button[@name='action_view_delivery']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>

                <xpath expr="//button[@name='action_view_delivery']" position="after">
                    <button type="object"
                        name="action_view_combined_transfers"
                        class="oe_stat_button"
                        icon="fa-exchange"
                        attrs="{'invisible': [('delivery_count', '=', 0)]}">
                        <field name="delivery_count" widget="statinfo" string="Giao Nhận"/>
                    </button>
                </xpath>
                
                <xpath expr="//field[@name='payment_term_id']" position="after">
                    <field name="auto_balance_money"/>
                </xpath>
                
                <xpath expr="//field[@name='order_line']/tree/control" position="replace">
                    <control>
                        <create name="add_sell_control" string="Thêm hàng bán" context="{'default_is_trade_in': False, 'default_sequence': 10}"/>
                        <create name="add_buy_control" string="Thêm hàng mua" context="{'default_is_trade_in': True, 'default_sequence': 110}"/>
                        <create name="add_section_control" string="Thêm tiêu đề" context="{'default_display_type': 'line_section'}"/>
                        <create name="add_note_control" string="Thêm ghi chú" context="{'default_display_type': 'line_note'}"/>
                    </control>
                </xpath>
                <xpath expr="//field[@name='order_line']/tree" position="attributes">
                    <attribute name="decoration-success">is_auto_balance == True</attribute>
                    <attribute name="decoration-danger">qty_delivered &lt; product_uom_qty and parent.state in ('sale', 'done') and not is_trade_in</attribute>
                    <attribute name="decoration-warning">qty_delivered &lt; product_uom_qty and parent.state in ('sale', 'done') and is_trade_in</attribute>
                    <attribute name="decoration-bf">is_auto_balance == True</attribute>
                    <attribute name="default_order">sequence, id</attribute>
                </xpath>
                <xpath expr="//field[@name='order_line']/tree/field[@name='name']" position="before">
                    <field name="state" invisible="1"/>
                    <field name="sequence" widget="handle"/>
                </xpath>
                <xpath expr="//field[@name='order_line']/tree/field[@name='name']" position="after">
                    <field name="is_auto_balance" invisible="1" force_save="1"/>
                </xpath>

                <xpath expr="//notebook" position="after">
                    <separator string="Đơn hàng chưa hoàn thành" style="background-color: lightgrey;"   />
                    <field name="pending_order_ids" mode="tree" readonly="1">
                        <tree>
                            <field name="name"/>
                            <field name="date_order"/>
                            <field name="amount_total" sum="Total Tax Included"/>
                            <field name="state" invisible="1"/>
                            <field name="custom_state" 
                                widget="badge" 
                                decoration-success="custom_state == 'done_delivery'" 
                                decoration-info="custom_state == 'partial'" 
                                decoration-muted="custom_state == 'invoiced'"/>
                        </tree>
                    </field>
                    
                    <separator string="Đơn Cầm cố / Vay mượn đang hiệu lực" style="background-color: #ffeba1; margin-top: 20px;"/>
                    <field name="pending_pawn_ids" mode="tree" readonly="1">
                        <tree>
                            <field name="name"/>
                            <field name="date_order"/>
                            <field name="amount_loan" sum="Tổng vay"/>
                            <field name="interest_rate"/>
                            <!-- state is already here as badge, but let's make sure it's available for logic if needed, although visible field is enough -->
                             <field name="state" 
                                widget="badge" 
                                decoration-info="state == 'draft'" 
                                decoration-warning="state == 'confirmed'"/>
                        </tree>
                    </field>
                </xpath>

            </field>
        </record> 

        <record id="view_order_tree_trade_in_custom" model="ir.ui.view">
            <field name="name">sale.order.tree.trade.in.custom</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_tree"/>
            <field name="arch" type="xml">
                <tree position="attributes">
                    <attribute name="decoration-warning">invoice_status == 'invoiced'</attribute>
                </tree>
                <field name="name" position="attributes">
                    <attribute name="string">Mã GD</attribute>
                </field>
                <field name="partner_id" position="attributes">
                    <attribute name="string">Bạn hàng</attribute>
                </field>
                <field name="partner_id" position="after">
                    <field name="note" string="Ghi chú" optional="show"/>
                    <field name="summary_goods_in" string="Hàng Nhập" optional="show"/>
                    <field name="summary_goods_out" string="Hàng Xuất" optional="show"/>
                    <field name="money_total_in" string="Tiền Nhập" optional="show" decoration-danger="1" sum="Tổng Tiền Nhập"/>
                    <field name="money_total_out" string="Tiền Xuất" optional="show" decoration-danger="1" sum="Tổng Tiền Xuất"/>
                </field>
                <field name="date_order" position="attributes">
                    <attribute name="string">Thời gian</attribute>
                    <attribute name="widget">datetime</attribute>
                </field>
                <field name="date_order" position="after">
                    <field name="create_date" string="Thời gian lưu" widget="datetime" optional="show"/>
                </field>
                <field name="state" position="replace">
                    <field name="custom_state" string="Tình trạng" 
                        decoration-success="custom_state == 'done_delivery'" 
                        decoration-info="custom_state == 'partial'" 
                        decoration-muted="custom_state == 'invoiced'"
                        widget="badge"/>
                    <field name="state" invisible="1"/>
                </field>
                
                <!-- Hide unnecessary columns to match the simple view -->
                <field name="user_id" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
                <field name="team_id" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
                <field name="company_id" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
                <field name="amount_total" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
                <field name="invoice_status" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
                <field name="activity_ids" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
                 <field name="amount_tax" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
                 <field name="expected_date" position="attributes">
                    <attribute name="optional">hide</attribute>
                </field>
            </field>
        </record>
    </data>
</odoo>